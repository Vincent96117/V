<!DOCTYPE html>
<html>
<head>
    <title>âš¡ SNIPER V3.0 OMEGA - FULL SPEC ENGINE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #000; color: #e4e4e7; font-family: 'JetBrains Mono', monospace; overflow: hidden; }
        .section-title { border-bottom: 2px solid #1a1a1a; padding-bottom: 8px; margin-bottom: 12px; font-weight: 900; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; }
        .card { background: #09090b; border: 1px solid #18181b; border-left-width: 4px; transition: all 0.2s; }
        .card-v { border-left-color: #ef4444; background: linear-gradient(90deg, #450a0a66, transparent); }
        .card-s { border-left-color: #10b981; background: linear-gradient(90deg, #064e3b66, transparent); }
        .card-normal { border-left-color: #3b82f6; }
        .speed-blink { animation: blink 0.4s infinite; color: #ff0000 !important; font-weight: 900; text-shadow: 0 0 8px #ff0000; }
        @keyframes blink { 0%, 100% { opacity: 1; transform: scale(1.02); } 50% { opacity: 0.6; transform: scale(1); } }
        .tag-v { background: #ef4444; color: white; padding: 1px 4px; border-radius: 2px; font-size: 9px; }
        .tag-s { background: #10b981; color: white; padding: 1px 4px; border-radius: 2px; font-size: 9px; }
        ::-webkit-scrollbar { width: 3px; }
        ::-webkit-scrollbar-thumb { background: #3f3f46; }
    </style>
</head>
<body class="flex h-screen p-3 gap-3">

    <div class="flex-1 flex flex-col bg-zinc-950/50 rounded-xl p-3 border border-zinc-900">
        <div class="section-title text-blue-500 flex justify-between">
            <span>ğŸš€ é ˜èˆªå¼·å‹¢ (Original 10+10)</span>
        </div>
        <div id="strong-list" class="flex-1 overflow-y-auto space-y-2 mb-4"></div>
        <div class="section-title text-zinc-600">ğŸ“¡ è“„å‹¢å€™è£œ</div>
        <div id="backup-list" class="h-1/3 overflow-y-auto space-y-2 opacity-50"></div>
    </div>

    <div class="w-80 flex flex-col bg-zinc-950/50 rounded-xl p-3 border border-zinc-900">
        <div class="section-title text-red-500">ğŸ¯ V-SNIPER (èµ·è·Œé»åŸºæº–)</div>
        <div id="v-list" class="flex-1 overflow-y-auto space-y-2"></div>
    </div>

    <div class="w-80 flex flex-col bg-zinc-950/50 rounded-xl p-3 border border-zinc-900">
        <div class="section-title text-emerald-500">ğŸ“ SQUEEZE (ä¸»å‹•åƒè²¨ç›£æ§)</div>
        <div id="s-list" class="flex-1 overflow-y-auto space-y-2"></div>
    </div>

<script>
    const EXCLUDE = ['BTCUSDT','ETHUSDT','SOLUSDT','XRPUSDT','BNBUSDT','BNXUSDT'];
    let stats = {}, baselineData = {}, pinned = new Set();

    async function fetchBaselines(s) {
        try {
            const [k, h, t24] = await Promise.all([
                fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${s}&interval=1d&limit=5`).then(r=>r.json()),
                fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${s}&interval=1h&limit=120`).then(r=>r.json()),
                fetch(`https://fapi.binance.com/fapi/v1/ticker/24hr?symbol=${s}`).then(r=>r.json())
            ]);
            let tV=0, tQ=0, tA=0; 
            k.forEach(v=>{ tA+=(v[2]-v[3])/v[1]; tV+=parseFloat(v[5]); tQ+=parseFloat(v[7]); });
            baselineData[s] = { avgAmp: tA/5, wap5d: tQ/tV, avgTradesHr: h.reduce((a,c)=>a+parseInt(c[8]),0)/120, wap24h: parseFloat(t24.weightedAvgPrice) };
        } catch(e) {}
    }

    // --- ç¡¬æ ¸ç®—æ³•æ•´åˆ ---
    function analyzeMarket(s, t, f) {
        const pNow = parseFloat(t.lastPrice);
        const trades = parseInt(t.count);
        
        if(!stats[s].engine) stats[s].engine = { td:0, type:null, prices:[], startTrades:trades, sumTrades:0, countTicks:0, takerBuyVol:0, totalVol:0 };
        let eng = stats[s].engine;

        // A. TD åºåˆ—èˆ‡èµ·è·Œé»é‡ç½®
        eng.prices.push(pNow); if(eng.prices.length > 5) eng.prices.shift();
        if(eng.prices.length === 5) {
            let ref = eng.prices[0];
            let newType = (pNow < ref) ? 'buy' : 'sell';
            if(newType !== eng.type) {
                eng.td = 1; eng.type = newType;
                eng.startTrades = trades; eng.sumTrades = 0; eng.countTicks = 0; // é‡ç½®èµ·è·Œé»åŸºæº–
            } else { eng.td++; }
        }

        // B. å‹•æ…‹å¿ƒè·³ (ç•¶å‰ 3s vs èµ·è·Œé»å¹³å‡)
        let tickTrades = Math.max(0, trades - (stats[s].lastTrades || trades));
        stats[s].lastTrades = trades;
        eng.sumTrades += tickTrades; eng.countTicks++;
        let avgBase = eng.sumTrades / eng.countTicks;
        let pulseRatio = tickTrades / (avgBase || 1);

        // C. ä¸»å‹•è²·å…¥æ¯” (ç°¡åŒ–æ¨¡æ“¬, å¯¦æˆ°éœ€ç”¨ WebSocket Aggregate Trade)
        // é€™è£¡ç”¨åƒ¹æ ¼èˆ‡ 24H å‡åƒ¹çš„é—œä¿‚è¼”åŠ©åˆ¤å®šåƒè²¨æ„åœ–
        let distVWAP = ((pNow / baselineData[s].wap24h) - 1) * 100;
        
        return { td: eng.td, pulse: pulseRatio, distVWAP: distVWAP };
    }

    async function update() {
        const [fRes, tRes] = await Promise.all([
            fetch('https://fapi.binance.com/fapi/v1/premiumIndex'),
            fetch('https://fapi.binance.com/fapi/v1/ticker/24hr')
        ]);
        const fData = await fRes.json(), tData = await tRes.json(), tMap = new Map(tData.map(t=>[t.symbol,t]));
        
        let originalPool = [], vPool = [], sPool = [];

        fData.forEach(c => {
            const s = c.symbol; if(!s.endsWith('USDT') || (EXCLUDE.includes(s) && !pinned.has(s))) return;
            const t = tMap.get(s); if(!t || !baselineData[s]) return;
            const funding = parseFloat(c.lastFundingRate);
            if(Math.abs(funding) < 0.0005) return; // 0.05% è³‡è²»é–€æª»

            if(!stats[s]) stats[s] = { startTrades: parseInt(t.count), startTime: Date.now() };

            // 1. èˆŠç®—æ³• (é ˜èˆªæ¦œ 10+10)
            const hScore = ((parseInt(t.count)-stats[s].startTrades)*(60/Math.max(1,(Date.now()-stats[s].startTime)/60000)))/baselineData[s].avgTradesHr;
            const vScore = ((parseFloat(t.highPrice)-parseFloat(t.lowPrice))/parseFloat(t.openPrice))/baselineData[s].avgAmp;
            originalPool.push({ s, pNow: parseFloat(t.lastPrice), funding, hScore, vScore, score: (vScore*0.5 + hScore*0.5) });

            // 2. æ ¸å¿ƒå¼•æ“åˆ†æ
            const analysis = analyzeMarket(s, t, c);

            // 3. V-SNIPER å¼•æ“ (æ¢ä»¶ï¼šTD 13+ ä¸” å¿ƒè·³ > 3å€ ä¸” Drive çœŸç©º[é«˜æ–¼åŸºæº–])
            if(analysis.td >= 13 && analysis.pulse > 3.0) {
                vPool.push({ s, pNow: parseFloat(t.lastPrice), td: analysis.td, pulse: analysis.pulse, dist: analysis.distVWAP });
            }

            // 4. SQUEEZE å¼•æ“ (æ¢ä»¶ï¼šæ¥µè‡´çª’æ¯ VOL<0.3 ä¸” è²¼åˆå‡åƒ¹ dist<0.3%)
            if(vScore < 0.35 && Math.abs(analysis.distVWAP) < 0.3) {
                sPool.push({ s, pNow: parseFloat(t.lastPrice), vScore, dist: analysis.distVWAP, pulse: analysis.pulse });
            }
        });

        // æ’åºèˆ‡æ¸²æŸ“
        originalPool.sort((a,b)=>b.score-a.score);
        renderList(originalPool.slice(0,10), 'strong-list', 'card-normal');
        renderList(originalPool.slice(10,20), 'backup-list', 'card-normal');

        vPool.sort((a,b)=>b.pulse - a.pulse);
        renderV(vPool.slice(0,10), 'v-list');

        sPool.sort((a,b)=>a.vScore - b.vScore);
        renderS(sPool.slice(0,10), 's-list');
    }

    function renderList(items, id, cls) {
        const el = document.getElementById(id); el.innerHTML = '';
        items.forEach(i => {
            el.innerHTML += `<div class="card p-3 rounded-lg ${cls} mb-2">
                <div class="flex justify-between font-bold text-white text-[11px]"><span>${i.s.replace('USDT','')}</span><span>$${i.pNow.toFixed(4)}</span></div>
                <div class="flex justify-between text-[9px] mt-1 text-zinc-500"><span>ğŸ’“ SPEED: ${i.hScore.toFixed(1)}X</span><span>ğŸŒŠ VOL: ${i.vScore.toFixed(1)}X</span></div>
            </div>`;
        });
    }

    function renderV(items, id) {
        const el = document.getElementById(id); el.innerHTML = '';
        items.forEach(i => {
            el.innerHTML += `<div class="card p-3 rounded-lg card-v">
                <div class="flex justify-between font-black text-white text-[11px]">
                    <span>${i.s.replace('USDT','')}</span>
                    <span class="tag-v">TD ${i.td}</span>
                </div>
                <div class="flex justify-between mt-2">
                    <span class="text-[12px] font-black ${i.pulse>3?'speed-blink':'text-zinc-400'}">PULSE: ${i.pulse.toFixed(1)}X</span>
                    <span class="text-[9px] text-zinc-500">GAP: ${i.dist.toFixed(2)}%</span>
                </div>
                <div class="text-[8px] text-red-400 mt-1 italic">èµ·è·Œé»åŸºæº–å¿ƒè·³ç›£æ§ä¸­...</div>
            </div>`;
        });
    }

    function renderS(items, id) {
        const el = document.getElementById(id); el.innerHTML = '';
        items.forEach(i => {
            el.innerHTML += `<div class="card p-3 rounded-lg card-s">
                <div class="flex justify-between font-black text-white text-[11px]">
                    <span>${i.s.replace('USDT','')}</span>
                    <span class="tag-s text-white">SQUEEZE</span>
                </div>
                <div class="flex justify-between mt-2">
                    <span class="text-[11px] font-black text-emerald-400">VOL: ${i.vScore.toFixed(2)}X</span>
                    <span class="text-[10px] text-white">WAP: ${i.dist.toFixed(2)}%</span>
                </div>
                <div class="text-[8px] text-emerald-600 mt-1 italic">å‡åƒ¹å¼•åŠ›ï¼šä¸»å‹•åƒè²¨åˆ¤å®šä¸­...</div>
            </div>`;
        });
    }

    async function init() {
        const data = await fetch('https://fapi.binance.com/fapi/v1/ticker/24hr').then(r=>r.json());
        const targets = data.filter(s => s.symbol.endsWith('USDT') && !EXCLUDE.includes(s.symbol)).sort((a,b)=>b.quoteVolume-a.quoteVolume).slice(0, 150);
        for(let i=0; i<targets.length; i+=10) { await Promise.all(targets.slice(i, i+10).map(s => fetchBaselines(s.symbol))); }
        setInterval(update, 3000);
    }
    init();
</script>
</body>
</html>
