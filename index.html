<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>âš¡ SNIPER V3.8 OMEGA - UNLIMITED TD</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #000; color: #e4e4e7; font-family: 'JetBrains Mono', monospace; overflow: hidden; }
        .section-title { border-bottom: 2px solid #1a1a1a; padding-bottom: 8px; margin-bottom: 12px; font-weight: 900; font-size: 11px; text-transform: uppercase; }
        .card { background: #09090b; border: 1px solid #18181b; border-left-width: 4px; transition: all 0.3s; position: relative; }
        .card-v { border-left-color: #ef4444; }
        .card-s { border-left-color: #10b981; }
        
        /* é€²å ´é–ƒçˆæé†’ */
        .fire-alert { border: 2px solid #f0abfc; background: linear-gradient(90deg, #701a75, transparent); animation: fire 0.4s infinite; }
        @keyframes fire { 0%, 100% { transform: scale(1.01); filter: brightness(1.2); } 50% { filter: brightness(0.8); } }
        
        /* ç‹€æ…‹å‘¼å¸ç‡ˆ */
        .sync-led { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .led-active { background: #3b82f6; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        
        .time-tag { font-size: 8px; color: #52525b; position: absolute; bottom: 4px; right: 8px; }
        ::-webkit-scrollbar { width: 3px; }
        ::-webkit-scrollbar-thumb { background: #27272a; }
    </style>
</head>
<body class="flex h-screen p-3 gap-3">

    <div class="flex-1 flex flex-col bg-zinc-950 p-3 border border-zinc-900 rounded-xl text-[11px]">
        <div class="section-title text-blue-400 flex justify-between">
            <span>ğŸš€ é ˜èˆªå¼·å‹¢ (Top 15)</span>
            <div id="status-led"><span class="sync-led led-active"></span><span class="text-[9px]">LIVE SCAN</span></div>
        </div>
        <div id="strong-list" class="flex-1 overflow-y-auto space-y-1 mb-2"></div>
    </div>

    <div class="flex-1 flex flex-col bg-zinc-950 p-3 border border-zinc-900 rounded-xl">
        <div class="section-title text-red-500 flex justify-between">
            <span>ğŸ¯ V-SNIPER (2M Cycle)</span>
            <span id="v-count" class="text-[9px] text-zinc-600">0 ACTIVE</span>
        </div>
        <div id="v-list" class="flex-1 overflow-y-auto space-y-2"></div>
    </div>

    <div class="flex-1 flex flex-col bg-zinc-950 p-3 border border-zinc-900 rounded-xl">
        <div class="section-title text-emerald-500 flex justify-between">
            <span>ğŸ“ SQUEEZE (5M Sticky)</span>
            <span id="s-count" class="text-[9px] text-zinc-600">0 ACTIVE</span>
        </div>
        <div id="s-list" class="flex-1 overflow-y-auto space-y-2"></div>
    </div>

<script>
    // --- ä½¿ç”¨è€…å®šç¾©éæ¿¾ç³»çµ± ---
    const EXCLUDE = ['BTCUSDT','ETHUSDT','SOLUSDT','XRPUSDT','BNBUSDT','BNXUSDT'];
    let stats = {}, baselineData = {}, isInitialized = false;
    let vSticky = new Map(), sSticky = new Map();
    const STICKY_TIME = 5 * 60 * 1000; // 5åˆ†é˜ç•™æ¦œ

    // --- API å®‰å…¨åˆå§‹åŒ– ---
    async function getSymbolDataSecure(s) {
        try {
            const k = await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${s}&interval=1d&limit=5`).then(r=>r.json());
            await new Promise(r => setTimeout(r, 60)); // åºåˆ—åŒ–åœé “
            const h = await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${s}&interval=1h&limit=120`).then(r=>r.json());
            await new Promise(r => setTimeout(r, 60));
            const t24 = await fetch(`https://fapi.binance.com/fapi/v1/ticker/24hr?symbol=${s}`).then(r=>r.json());
            
            let tV=0, tQ=0, tA=0; 
            k.forEach(v=>{ tA+=(v[2]-v[3])/v[1]; tV+=parseFloat(v[5]); tQ+=parseFloat(v[7]); });
            baselineData[s] = { 
                avgAmp: tA/5, 
                avgTradesHr: h.reduce((a,c)=>a+parseInt(c[8]),0)/120, 
                wap24h: parseFloat(t24.weightedAvgPrice) 
            };
        } catch(e) { console.error(`Error loading ${s}`); }
    }

    // --- æ ¸å¿ƒç‰©ç†å¼•æ“ (2åˆ†é˜é€±æœŸ TD) ---
    function analyzeEngine(s, pNow, currentTrades) {
        if(!stats[s].engine) stats[s].engine = { td:0, type:null, history:[], sumTrades:0, countTicks:0 };
        let eng = stats[s].engine;
        
        eng.history.push(pNow); 
        if(eng.history.length > 120) eng.history.shift(); // ç·©å­˜ç´„ 6 åˆ†é˜

        // 2åˆ†é˜æ­¥é•·è¨­å®š (40é€±æœŸ * 3ç§’ = 120ç§’)
        if(eng.history.length >= 41) {
            let refPrice = eng.history[eng.history.length - 41]; 
            let newType = (pNow < refPrice) ? 'buy' : 'sell';
            if(newType !== eng.type) {
                eng.td = 1; eng.type = newType;
                eng.sumTrades = 0; eng.countTicks = 0; // è¶¨å‹¢è½‰å‘é‡ç½®å¿ƒè·³åŸºæº–
            } else { eng.td++; }
        }

        let tickTrades = Math.max(0, currentTrades - (stats[s].lastTrades || currentTrades));
        stats[s].lastTrades = currentTrades;
        eng.sumTrades += tickTrades; eng.countTicks++;
        let avgBase = eng.sumTrades / (eng.countTicks || 1);
        
        return { td: eng.td, pulse: tickTrades / (avgBase || 1) };
    }

    // --- æ¯ 3 ç§’æƒæå…¨å¸‚å ´ ---
    async function update() {
        if(!isInitialized) return;
        try {
            const [fRes, tRes] = await Promise.all([
                fetch('https://fapi.binance.com/fapi/v1/premiumIndex'),
                fetch('https://fapi.binance.com/fapi/v1/ticker/24hr')
            ]);
            const fData = await fRes.json(), tData = await tRes.json();
            const tMap = new Map(tData.map(t=>[t.symbol,t]));
            const now = Date.now();
            let originalPool = [];

            fData.forEach(c => {
                const s = c.symbol;
                if(!s.endsWith('USDT') || EXCLUDE.includes(s) || !baselineData[s]) return;
                
                // è³‡è²»éæ¿¾: æ­£è²  0.05%
                if(Math.abs(parseFloat(c.lastFundingRate)) < 0.0005) return; 

                const t = tMap.get(s);
                const pNow = parseFloat(t.lastPrice);
                if(!stats[s]) stats[s] = { startTrades: parseInt(t.count), startTime: now };

                const hScore = ((parseInt(t.count)-stats[s].startTrades)*(60/Math.max(1,(now-stats[s].startTime)/60000)))/baselineData[s].avgTradesHr;
                const vScore = ((parseFloat(t.highPrice)-parseFloat(t.lowPrice))/parseFloat(t.openPrice))/baselineData[s].avgAmp;
                const distVWAP = ((pNow / baselineData[s].wap24h) - 1) * 100;
                
                const eng = analyzeEngine(s, pNow, parseInt(t.count));

                originalPool.push({ s, pNow, hScore, vScore, score: (vScore*0.5 + hScore*0.5) });

                // V-SNIPER åˆ¤å®š: è§£é™¤ 13 ä¸Šé™ï¼Œåªè¦ TD >= 9 ä¸”çˆ†é‡å³è§¸ç™¼
                if(eng.td >= 9 && eng.pulse > 2.0) {
                    vSticky.set(s, { pNow, td: eng.td, pulse: eng.pulse, expiry: now + STICKY_TIME });
                }

                // SQUEEZE åˆ¤å®š
                if(vScore < 0.35 && Math.abs(distVWAP) < 0.3) {
                    sSticky.set(s, { pNow, vScore, distVWAP, pulse: eng.pulse, expiry: now + STICKY_TIME });
                }
            });

            // æ¸…ç†éæœŸç•™æ¦œ
            for (let [s, d] of vSticky) { if (now > d.expiry) vSticky.delete(s); }
            for (let [s, d] of sSticky) { if (now > d.expiry) sSticky.delete(s); }

            render(originalPool, vSticky, sSticky);
        } catch(e) {}
    }

    // --- ä»‹é¢æ¸²æŸ“èˆ‡ FIRE é€²å ´åˆ¤å®š ---
    function render(orig, vMap, sMap) {
        // é ˜èˆªæ¦œ
        orig.sort((a,b)=>b.score-a.score);
        const sList = document.getElementById('strong-list'); sList.innerHTML = '';
        orig.slice(0,15).forEach(i => {
            sList.innerHTML += `<div class="card p-2 rounded border-l-blue-500 mb-1">
                <div class="flex justify-between font-bold"><span>${i.s.replace('USDT','')}</span><span>$${i.pNow.toFixed(4)}</span></div>
                <div class="flex justify-between text-[9px] text-zinc-500"><span>ğŸ’“ ${i.hScore.toFixed(1)}X</span><span>ğŸŒŠ ${i.vScore.toFixed(1)}X</span></div>
            </div>`;
        });

        // V-SNIPER æ¸²æŸ“ (é€²å ´åˆ¤å®š)
        const vList = document.getElementById('v-list'); vList.innerHTML = '';
        const vArr = Array.from(vMap.entries()).sort((a,b)=>b[1].pulse - a[1].pulse);
        document.getElementById('v-count').innerText = `${vArr.length} ACTIVE`;
        vArr.forEach(([s, i]) => {
            // æ˜ç¢ºé€²å ´é»: TD 9 ä»¥ä¸Šä¸”å¿ƒè·³å™´ç™¼ 5 å€
            const isFire = i.pulse >= 5.0 && i.td >= 9;
            vList.innerHTML += `<div class="card p-3 rounded card-v mb-2 ${isFire?'fire-alert':''}">
                <div class="flex justify-between font-black">
                    <span>${s.replace('USDT','')} ${isFire?'<span class="bg-fuchsia-600 px-1 rounded text-white animate-pulse text-[10px]">ğŸ”¥ FIRE</span>':''}</span>
                    <span class="${i.td>=9?'text-red-500 underline':''}">TD ${i.td}</span>
                </div>
                <div class="flex justify-between mt-2 font-bold">
                    <span class="${i.pulse>=5?'text-fuchsia-400 text-[15px]':'text-zinc-400'}">PULSE: ${i.pulse.toFixed(1)}X</span>
                    <span class="text-white">$${i.pNow.toFixed(4)}</span>
                </div>
                <div class="time-tag">EXIT IN ${Math.round((i.expiry-Date.now())/1000)}S</div>
            </div>`;
        });

        // SQUEEZE æ¸²æŸ“
        const sListEl = document.getElementById('s-list'); sListEl.innerHTML = '';
        document.getElementById('s-count').innerText = `${sMap.size} ACTIVE`;
        Array.from(sMap.entries()).forEach(([s, i]) => {
            const isFire = i.pulse >= 3.5;
            sListEl.innerHTML += `<div class="card p-3 rounded card-s mb-2 ${isFire?'fire-alert':''}">
                <div class="flex justify-between font-black text-white">
                    <span>${s.replace('USDT','')} ${isFire?'<span class="bg-emerald-600 px-1 rounded animate-pulse text-[10px]">ğŸ”¥ FIRE</span>':''}</span>
                    <span class="text-emerald-500">SQZ</span>
                </div>
                <div class="flex justify-between mt-2 text-[10px] font-bold">
                    <span class="${isFire?'text-emerald-400':''}">PULSE: ${i.pulse.toFixed(1)}X</span>
                    <span>VWAP: ${i.distVWAP.toFixed(2)}%</span>
                </div>
                <div class="time-tag">EXIT IN ${Math.round((i.expiry-Date.now())/1000)}S</div>
            </div>`;
        });
    }

    async function init() {
        const data = await fetch('https://fapi.binance.com/fapi/v1/ticker/24hr').then(r=>r.json());
        const targets = data.filter(s => s.symbol.endsWith('USDT') && !EXCLUDE.includes(s.symbol)).sort((a,b)=>b.quoteVolume-a.quoteVolume).slice(0, 120);
        for (const target of targets) { await getSymbolDataSecure(target.symbol); }
        isInitialized = true;
        setInterval(update, 3000);
    }
    init();
</script>
</body>
</html>
