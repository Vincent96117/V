<!DOCTYPE html>
<html>
<head>
    <title>âš¡ SNIPER V3.0 OMEGA - SECURE ENGINE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #000; color: #e4e4e7; font-family: 'JetBrains Mono', monospace; overflow: hidden; }
        .section-title { border-bottom: 2px solid #1a1a1a; padding-bottom: 8px; margin-bottom: 12px; font-weight: 900; font-size: 11px; text-transform: uppercase; }
        .card { background: #09090b; border: 1px solid #18181b; border-left-width: 4px; }
        .card-v { border-left-color: #ef4444; background: linear-gradient(90deg, #450a0a44, transparent); }
        .card-s { border-left-color: #10b981; background: linear-gradient(90deg, #064e3b44, transparent); }
        .card-normal { border-left-color: #3b82f6; }
        .speed-blink { animation: blink 0.5s infinite; color: #ff4444 !important; font-weight: 900; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        ::-webkit-scrollbar { width: 3px; }
        ::-webkit-scrollbar-thumb { background: #27272a; }
    </style>
</head>
<body class="flex h-screen p-3 gap-3">

    <div class="flex-1 flex flex-col bg-zinc-950 p-3 border border-zinc-900 rounded-xl">
        <div class="section-title text-blue-500">ğŸš€ é ˜èˆªå¼·å‹¢ (TOP 10)</div>
        <div id="strong-list" class="flex-1 overflow-y-auto space-y-2 mb-4"></div>
        <div class="section-title text-zinc-600 italic">ğŸ“¡ è“„å‹¢å€™è£œ</div>
        <div id="backup-list" class="h-1/3 overflow-y-auto space-y-2 opacity-40"></div>
    </div>

    <div class="w-80 flex flex-col bg-zinc-950 p-3 border border-zinc-900 rounded-xl">
        <div class="section-title text-red-500 flex justify-between">
            <span>ğŸ¯ V-SNIPER</span>
            <span id="v-status" class="text-[9px] text-zinc-600">WATCHING</span>
        </div>
        <div id="v-list" class="flex-1 overflow-y-auto space-y-2 text-red-100"></div>
    </div>

    <div class="w-80 flex flex-col bg-zinc-950 p-3 border border-zinc-900 rounded-xl">
        <div class="section-title text-emerald-500 flex justify-between">
            <span>ğŸ“ SQUEEZE</span>
            <span id="s-status" class="text-[9px] text-zinc-600">SENSING</span>
        </div>
        <div id="s-list" class="flex-1 overflow-y-auto space-y-2 text-emerald-100"></div>
    </div>

<script>
    const EXCLUDE = ['BTCUSDT','ETHUSDT','SOLUSDT','XRPUSDT','BNBUSDT','BNXUSDT'];
    let stats = {}, baselineData = {};
    let isInitialized = false;

    // --- åš´æ ¼åºåˆ—åŒ–æŠ“å–ï¼šä¸€æ¬¡åªæŠ“ä¸€éš»å¹£çš„ä¸€å€‹å‹•ä½œ ---
    async function getSymbolDataSecure(s) {
        try {
            // åˆ†é–‹è«‹æ±‚ï¼Œä¸ä½¿ç”¨ Promise.allï¼Œå¾¹åº•é™ä½ç¬æ™‚ä½µç™¼
            const kRes = await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${s}&interval=1d&limit=5`);
            const k = await kRes.json();
            await new Promise(r => setTimeout(r, 50)); // å‘¼å¸åœé “

            const hRes = await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${s}&interval=1h&limit=120`);
            const h = await hRes.json();
            await new Promise(r => setTimeout(r, 50)); // å‘¼å¸åœé “

            const tRes = await fetch(`https://fapi.binance.com/fapi/v1/ticker/24hr?symbol=${s}`);
            const t24 = await tRes.json();

            let tV=0, tQ=0, tA=0; 
            k.forEach(v=>{ tA+=(v[2]-v[3])/v[1]; tV+=parseFloat(v[5]); tQ+=parseFloat(v[7]); });
            baselineData[s] = { 
                avgAmp: tA/5, 
                wap5d: tQ/tV, 
                avgTradesHr: h.reduce((a,c)=>a+parseInt(c[8]),0)/120, 
                wap24h: parseFloat(t24.weightedAvgPrice) 
            };
        } catch(e) { console.error(`Error on ${s}`); }
    }

    function processEngines(s, pNow, currentTrades) {
        if(!stats[s].engine) stats[s].engine = { td:0, type:null, prices:[], sumTrades:0, countTicks:0 };
        let eng = stats[s].engine;

        // TD é‚è¼¯èˆ‡åŸºæº–é‡ç½®
        eng.prices.push(pNow); if(eng.prices.length > 5) eng.prices.shift();
        if(eng.prices.length === 5) {
            let ref = eng.prices[0];
            let newType = (pNow < ref) ? 'buy' : 'sell';
            if(newType !== eng.type) {
                eng.td = 1; eng.type = newType;
                eng.sumTrades = 0; eng.countTicks = 0; // è½‰å‘ç«‹åˆ»é‡ç½®èµ·è·Œé»åŸºæº–
            } else { eng.td++; }
        }

        // å¿ƒè·³åŸºæº–è¨ˆç®—
        let tickTrades = Math.max(0, currentTrades - (stats[s].lastTrades || currentTrades));
        stats[s].lastTrades = currentTrades;
        eng.sumTrades += tickTrades; eng.countTicks++;
        let avgBase = eng.sumTrades / eng.countTicks;
        
        return { td: eng.td, pulse: tickTrades / (avgBase || 1) };
    }

    async function update() {
        if(!isInitialized) return;
        try {
            // æ¯ 3 ç§’åªç™¼é€é€™å…©å€‹æ ¸å¿ƒå¤§å°åŒ…ï¼Œç›£æ§å…¨å¸‚å ´
            const [fRes, tRes] = await Promise.all([
                fetch('https://fapi.binance.com/fapi/v1/premiumIndex'),
                fetch('https://fapi.binance.com/fapi/v1/ticker/24hr')
            ]);
            const fData = await fRes.json(), tData = await tRes.json(), tMap = new Map(tData.map(t=>[t.symbol,t]));
            
            let originalPool = [], vPool = [], sPool = [];

            fData.forEach(c => {
                const s = c.symbol;
                if(!s.endsWith('USDT') || EXCLUDE.includes(s) || !baselineData[s]) return;
                
                const funding = parseFloat(c.lastFundingRate);
                if(Math.abs(funding) < 0.0005) return; // è³‡è²» 0.05%

                if(!stats[s]) stats[s] = { startTrades: parseInt(tMap.get(s).count), startTime: Date.now() };

                const t = tMap.get(s);
                const pNow = parseFloat(t.lastPrice);
                const hScore = ((parseInt(t.count)-stats[s].startTrades)*(60/Math.max(1,(Date.now()-stats[s].startTime)/60000)))/baselineData[s].avgTradesHr;
                const vScore = ((parseFloat(t.highPrice)-parseFloat(t.lowPrice))/parseFloat(t.openPrice))/baselineData[s].avgAmp;
                const distVWAP = ((pNow / baselineData[s].wap24h) - 1) * 100;

                const eng = processEngines(s, pNow, parseInt(t.count));

                // 1. é ˜èˆªæ¦œ
                originalPool.push({ s, pNow, hScore, vScore, score: (vScore*0.5 + hScore*0.5) });

                // 2. V-SNIPER (TD 13+ ä¸” 3å€å¿ƒè·³)
                if(eng.td >= 13 && eng.pulse > 3.0) vPool.push({ s, pNow, td: eng.td, pulse: eng.pulse });

                // 3. SQUEEZE (çª’æ¯ < 0.35 ä¸” è²¼åˆå‡åƒ¹ < 0.3%)
                if(vScore < 0.35 && Math.abs(distVWAP) < 0.3) sPool.push({ s, pNow, vScore, distVWAP });
            });

            render(originalPool, vPool, sPool);
        } catch(e) {}
    }

    function render(orig, v, s) {
        orig.sort((a,b)=>b.score-a.score);
        renderList(orig.slice(0,10), 'strong-list', 'card-normal');
        renderList(orig.slice(10,20), 'backup-list', 'card-normal');

        const vEl = document.getElementById('v-list'); vEl.innerHTML = '';
        v.sort((a,b)=>b.pulse-a.pulse).slice(0,10).forEach(i => {
            vEl.innerHTML += `<div class="card p-3 rounded-lg card-v mb-2">
                <div class="flex justify-between font-black"><span>${i.s.replace('USDT','')}</span><span class="text-red-500">TD ${i.td}</span></div>
                <div class="flex justify-between mt-2 font-bold"><span class="speed-blink text-[12px]">PULSE: ${i.pulse.toFixed(1)}X</span><span>$${i.pNow.toFixed(4)}</span></div>
            </div>`;
        });

        const sEl = document.getElementById('s-list'); sEl.innerHTML = '';
        s.sort((a,b)=>a.vScore-b.vScore).slice(0,10).forEach(i => {
            sEl.innerHTML += `<div class="card p-3 rounded-lg card-s mb-2">
                <div class="flex justify-between font-black text-white"><span>${i.s.replace('USDT','')}</span><span class="text-emerald-500">SQUEEZE</span></div>
                <div class="flex justify-between mt-2 text-[10px] font-bold"><span>VOL: ${i.vScore.toFixed(2)}X</span><span>VWAP: ${i.distVWAP.toFixed(2)}%</span></div>
            </div>`;
        });
    }

    function renderList(items, id, cls) {
        const el = document.getElementById(id); el.innerHTML = '';
        items.forEach(i => {
            el.innerHTML += `<div class="card p-3 rounded-lg ${cls} mb-2">
                <div class="flex justify-between font-bold text-white"><span>${i.s.replace('USDT','')}</span><span>$${i.pNow.toFixed(4)}</span></div>
                <div class="flex justify-between text-[9px] mt-1 text-zinc-500"><span>ğŸ’“ ${i.hScore.toFixed(1)}X</span><span>ğŸŒŠ ${i.vScore.toFixed(1)}X</span></div>
            </div>`;
        });
    }

    async function init() {
        const data = await fetch('https://fapi.binance.com/fapi/v1/ticker/24hr').then(r=>r.json());
        const targets = data.filter(s => s.symbol.endsWith('USDT') && !EXCLUDE.includes(s.symbol)).sort((a,b)=>b.quoteVolume-a.quoteVolume).slice(0, 120);
        
        // åš´æ ¼åºåˆ—åŒ–åˆå§‹åŒ–ï¼Œæ¯éš»å¹£ä¸­é–“éƒ½æœ‰åœé “
        for (const target of targets) {
            await getSymbolDataSecure(target.symbol);
        }
        
        isInitialized = true;
        setInterval(update, 3000);
    }
    init();
</script>
</body>
</html>
